<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd"> 
<html lang="en"> 
<head> 
	<meta http-equiv="content-type" content="text/html; charset=iso-8859-1"> 
	<title>Hexagonal Grid Test</title> 
	<style type="text/css" media="screen">
		body { background:#eee }
		#grid { margin:0 auto; width:1024px; height:768px; position:relative }
		#grid canvas { border:2px solid #333; background:#fff; }
		#output { position:absolute; top:1px; right:0px; padding:0.1em 0.5em; text-align:right; background:rgba(255, 255, 255, .8); }
		#offense, #defense { font-size:9pt; font-weight:bold; position:absolute; bottom:0; margin:0; right:0 }
		#offense { left:0; right:auto }
		
	</style>
	<script type="text/javascript" src="../js/jquery-1.4.2.min.js"></script>
	<script type="text/javascript" src="../js/cell.js"></script>
	<script type="text/javascript" src="../js/board.js"></script>
	<script type="text/javascript">
		// Hex Grid
		COL_OFFSET = 13.27;
		COL_WIDTH  = 41.567;
		CEL_OFFSET = 24;
		CEL_HEIGHT = 48;
		
		// MN grid coordinates
		MAX_M      = 22;
		MAX_N      = 15;

		// Graphic size
		HEX_WIDTH  = 55;
		HEX_HEIGHT = 48;

		$tiles = {};
		var names = "hexgrid border lightblue lightyellow orange black green red".split(" ");
		for (var i=names.length-1;i>=0;--i){
			$tiles[names[i]] = new Image;
			$tiles[names[i]].src = '../img/'+names[i]+'.png';
		}
		$tiles.path     = $tiles.lightyellow;
		$tiles.waypoint = $tiles.orange;
		$tiles.hole     = $tiles.black;
		$tiles.start    = $tiles.green;
		$tiles.finish   = $tiles.red;
		
		onload = function(){
			var waypoints=[null];
			$('#defense,#offense').mousedown(function(e){
				$board.overlays=[];
				waypoints.length=1;
				$board.mode=this.id;
				$board.redraw();
				e.stopPropagation();
			});

			$board = new Board( MAX_M, MAX_N, $('canvas')[0], $tiles );
			$board.startAt( -1, 5 );
			$board.finishAt( 23, -10 );
			$board.mode = 'offense';

			var lastCell = null;
			$('#grid').mousemove(function(e){
				if ($board.mode=='defense') return;
				var cell = Cell.fromXY(
					e.clientX - this.offsetLeft,
					e.clientY - this.offsetTop
				);
				if ($board.inBounds(cell)){
					if (!lastCell || !lastCell.sameAs(cell)){
						waypoints[waypoints.length-1] = cell;
						lastCell = cell;
						$board.overlays.length=0;
						var length=0;
						var route;
						var startPoint = $board.start;
						for (var i=0,len=waypoints.length;i<=len;++i){
							endPoint = (i==len) ? $board.finish : waypoints[i];
							if (route=$board.shortestPath(startPoint,endPoint)){
								for (var j=0,len2=route.length-1;j<len2;++j){
									route[j].type='path';
									$board.overlays[length++] = route[j];
								}
								// The very last end point is Finish; don't run over it.
								if (i<len){
									endPoint.type  = 'waypoint';
									$board.overlays[length++] = endPoint;
								}
								startPoint = endPoint;
							}else{
								$board.overlays.length=0;
								break;
							}
						}
						$('#output').html( $board.overlays.length || '-' );
					}
				}
				$board.redraw();
			}).mousedown(function(e){
				var cell = Cell.fromXY(
					e.clientX - this.offsetLeft,
					e.clientY - this.offsetTop
				);
				switch($board.mode){
					case 'defense':
						$board.placeTile(cell,'hole');
					break;
					case 'offense':
						waypoints[waypoints.length-1] = cell;
						waypoints.length += 1;
						console.log( waypoints.join("::") );
					break;
				}
			});
			
			$board.redraw();
		}
		
	</script> 
</head> 
<body>
<div id="grid">
	<div id="output">?SUP?</div>
	<button id="offense">offense</button>
	<button id="defense">defense</button>
	<canvas width="1024" height="768"></canvas>
</div>
</body></html>